<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>NFeBrasil by gbazilio</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>NFeBrasil</h1>
        <p>API de Nota Fiscal</p>

        <p class="view"><a href="https://github.com/gbazilio/nfebrasil">View the Project on GitHub <small>gbazilio/nfebrasil</small></a></p>


        <ul>
          <li><a href="https://github.com/gbazilio/nfebrasil/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/gbazilio/nfebrasil/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/gbazilio/nfebrasil">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h2>
<a id="nfebrasil-api" class="anchor" href="#nfebrasil-api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>NFeBrasil API</h2>

<p>A princípio, essa API tem um único objetivo que é recuperar dados de uma nota fiscal referente a chave de acesso desejada.</p>

<p>As informações são parseadas do site da <a href="http://www.nfe.fazenda.gov.br/portal/consulta.aspx?tipoConsulta=completa">Fazenda</a>.</p>

<h1>
<a id="documentação" class="anchor" href="#documenta%C3%A7%C3%A3o" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Documentação</h1>

<h3>
<a id="recuperar-dados-da-nf" class="anchor" href="#recuperar-dados-da-nf" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Recuperar dados da NF</h3>

<p>Recupera dados de uma nota fiscal eletrônica, que esteja acessível através do site da Fazenda, usando um captcha capturado do site.</p>

<table>
<thead>
<tr>
<th>URL</th>
<th>Verbo</th>
<th>Query String</th>
<th>Descrição</th>
</tr>
</thead>
<tbody>
<tr>
<td>/api/nfe/{chave_nfe}</td>
<td>GET</td>
<td>-</td>
<td>Busca um captcha</td>
</tr>
<tr>
<td>/api/nfe/{chave_nfe}</td>
<td>GET</td>
<td>captcha</td>
<td>Quando usado, recupera dados da NFE</td>
</tr>
</tbody>
</table>

<p><strong>Sucesso</strong> <code>200 OK</code> - Buscando captcha</p>

<pre><code>curl -H "Authorization: Bearer &lt;access_token&gt;" https://nfebrasil.herokuapp.com/api/nfe/&lt;chave_de_acesso&gt;
</code></pre>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>captcha_src<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>data:image/png;base64,iVBORw0K...<span class="pl-pds">"</span></span>
}</pre></div>

<p><strong>Sucesso</strong> <code>200 OK</code> - Buscando dados da NFe</p>

<pre><code>curl -H "Authorization: Bearer &lt;access_token&gt;" https://nfebrasil.herokuapp.com/api/nfe/&lt;chave_de_acesso&gt;?captcha=&lt;captcha&gt;
</code></pre>

<div class="highlight highlight-source-json"><pre>{<span class="pl-s"><span class="pl-pds">"</span>nfe<span class="pl-pds">"</span></span>: {
        <span class="pl-s"><span class="pl-pds">"</span>dados<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>serie<span class="pl-pds">"</span></span>: <span class="pl-ii">number</span>,
            <span class="pl-s"><span class="pl-pds">"</span>numero<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>total<span class="pl-pds">"</span></span>: <span class="pl-ii">number</span>
        },
        <span class="pl-s"><span class="pl-pds">"</span>emitente<span class="pl-pds">"</span></span>: {
            <span class="pl-s"><span class="pl-pds">"</span>cnpj<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>razao_social<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>nome_fantasia<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>endereco<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>uf<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>cidade<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
        },
        <span class="pl-s"><span class="pl-pds">"</span>items<span class="pl-pds">"</span></span>: [{
            <span class="pl-s"><span class="pl-pds">"</span>indice<span class="pl-pds">"</span></span>: <span class="pl-ii">number</span>,
            <span class="pl-s"><span class="pl-pds">"</span>descricao<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>quantidade<span class="pl-pds">"</span></span>: <span class="pl-ii">number</span>,
            <span class="pl-s"><span class="pl-pds">"</span>unidade<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
            <span class="pl-s"><span class="pl-pds">"</span>valor<span class="pl-pds">"</span></span>: <span class="pl-ii">number</span>
        }]
    }
}</pre></div>

<p><strong>Erro</strong> <code>403 Forbidden</code> - Credenciais inválidas</p>

<p><strong>Erro</strong> <code>502 Bad Gateway</code> - Modificação no site da Receita</p>

<div class="highlight highlight-source-json"><pre>{  
   <span class="pl-s"><span class="pl-pds">"</span>errors<span class="pl-pds">"</span></span>:[  
      {  
         <span class="pl-s"><span class="pl-pds">"</span>status<span class="pl-pds">"</span></span>: <span class="pl-c1">502</span>,
         <span class="pl-s"><span class="pl-pds">"</span>humanMessage<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>,
         <span class="pl-s"><span class="pl-pds">"</span>developerMessage<span class="pl-pds">"</span></span>: <span class="pl-ii">string</span>
      }
   ]
}</pre></div>

<h1>
<a id="consumindo-a-api" class="anchor" href="#consumindo-a-api" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Consumindo a API</h1>

<h3>
<a id="1-autenticação" class="anchor" href="#1-autentica%C3%A7%C3%A3o" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1. Autenticação</h3>

<p>Faço o cadastro da aplicação que irá consumir a API em <a href="https://nfebrasil.herokuapp.com/o/applications">https://nfebrasil.herokuapp.com/o/applications</a>.</p>

<p>Ex:
Client type: <code>Confidential</code><br>
Grant type: <code>Client credentials</code></p>

<p><strong>Importante:</strong> É recomendado o uso de fluxos OAuth não baseados em redirecionamento. Por isso não é necessário se preocupar com o campo <code>redirect uris</code>.</p>

<h3>
<a id="11-obtenha-o-access-token" class="anchor" href="#11-obtenha-o-access-token" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>1.1 Obtenha o Access Token</h3>

<p>Client credential:</p>

<pre><code>curl --user &lt;client_id&gt;:&lt;client_secret&gt; --data "grant_type=client_credentials" https://nfebrasil.herokuapp.com/o/token/
</code></pre>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>access_token<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>nuT0noX8eJgQQXc0o0mWL6uMoCFk88<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>scope<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>read<span class="pl-pds">"</span></span>, 
    <span class="pl-s"><span class="pl-pds">"</span>expires_in<span class="pl-pds">"</span></span>: <span class="pl-c1">36000</span>, 
    <span class="pl-s"><span class="pl-pds">"</span>token_type<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>Bearer<span class="pl-pds">"</span></span>
}</pre></div>

<h3>
<a id="2-captcha" class="anchor" href="#2-captcha" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>2. Captcha</h3>

<p>O site da fazenda solicita um captcha. Atualmente a forma que a API lida com isso é repassando o captcha para ser resolvido no lado do usuário:</p>

<p>Faça a primeira requisição para <a href="https://nfebrasil.herokuapp.com/api/nfe/">https://nfebrasil.herokuapp.com/api/nfe/</a> com o Access Token da requisição anterior.</p>

<pre><code>curl -H "Authorization: Bearer &lt;access_token&gt;" https://nfebrasil.herokuapp.com/api/nfe/&lt;chave_nfe&gt;
</code></pre>

<p>Receberá a seguinte resposta:</p>

<div class="highlight highlight-source-json"><pre>{
    <span class="pl-s"><span class="pl-pds">"</span>captcha_src<span class="pl-pds">"</span></span>: <span class="pl-s"><span class="pl-pds">"</span>data:image/png;base64,iVBORw0K...<span class="pl-pds">"</span></span>
}</pre></div>

<p>O valor de <code>captcha_src</code> deve ser entrada para a formação de uma imagem, por exemplo:</p>

<div class="highlight highlight-text-html-basic"><pre>&lt;<span class="pl-ent">img</span> <span class="pl-e">src</span>=<span class="pl-s"><span class="pl-pds">"</span>&lt;captcha_src&gt;<span class="pl-pds">"</span></span> /&gt;</pre></div>

<h3>
<a id="3-informações-da-nfe" class="anchor" href="#3-informa%C3%A7%C3%B5es-da-nfe" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>3. Informações da NFe</h3>

<p>Com o mesmo access token usado para fazer a requisição do captcha, faça um nova requisição passando o captcha decifrado e a chave de acesso:</p>

<p><strong>Importante</strong>: O tempo máximo entre a requisição do captcha e essa é de 50 segundos.</p>

<pre><code>curl -H "Authorization: Bearer nuT0noX8eJgQQXc0o0mWL6uMoCFk88" https://nfebrasil.herokuapp.com/api/nfe/&lt;chave_de_acesso&gt;?captcha=&lt;captcha&gt;
</code></pre>

<h1>
<a id="considerações" class="anchor" href="#considera%C3%A7%C3%B5es" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Considerações</h1>

<ul>
<li>A versão está em desenvolvimento. Sugira o que quiser.</li>
<li>O slash <code>/</code> no final das URLs são importantes.</li>
<li>A API não é e provavelmente não será estável. O parseamento usa XPath e por isso qualquer alteração na página de exibição da NF no site da Fazenda poderá quebrar a resposta.</li>
<li>O código estará no GitHub em breve.</li>
<li>Por pelo menos 30 minutos diário o serviço ficará offline pois está hospedado na conta free do Heroku.</li>
<li>Em breve, deixarei as rotas e códigos de resposta com mais semântica.</li>
</ul>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/gbazilio">gbazilio</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
